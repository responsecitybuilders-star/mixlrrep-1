<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Airvibe Studio | Mirinda 4000</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { background-color: #1a1a1d; color: #e5e5e5; font-family: 'Chakra Petch', sans-serif; overflow: hidden; height: 100vh; }
        
        .channel-strip {
            background: linear-gradient(180deg, #2a2a2e 0%, #1f1f22 100%);
            border: 1px solid #333;
            border-radius: 4px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 5px 5px 15px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; align-items: center; padding: 12px;
            position: relative;
        }
        
        .screw { width: 8px; height: 8px; border-radius: 50%; background: #444; border: 1px solid #111; box-shadow: inset 1px 1px 2px #555; position: absolute; }
        
        /* Vertical Range Slider */
        input[type=range][orient=vertical] {
            writing-mode: bt-lr; -webkit-appearance: slider-vertical;
            width: 60px; height: 100%;
            background: #111; border-radius: 4px; border: 1px solid #333;
        }

        .modal { background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        .scroller::-webkit-scrollbar { width: 4px; } .scroller::-webkit-scrollbar-thumb { background: #444; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="setup-modal" class="fixed inset-0 z-[100] modal flex items-center justify-center p-4">
        <div class="bg-[#111] border border-[#333] p-8 rounded-lg max-w-md w-full shadow-2xl relative">
            <h1 class="text-2xl font-bold text-white mb-2">INITIALIZE SYSTEM</h1>
            
            <div class="mb-6 bg-[#1a1a1d] p-3 rounded border border-[#333]">
                <label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">Audio Input Source</label>
                <select id="mic-select" class="w-full bg-black text-white text-xs p-2 border border-[#444] rounded outline-none">
                    <option value="default">Default Microphone</option>
                </select>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-indigo-400 uppercase">Broadcast Title</label>
                    <input id="station-name" type="text" class="w-full bg-[#050505] border border-[#333] p-3 text-white focus:border-indigo-500 outline-none rounded-sm font-mono" placeholder="e.g. Neon Nights FM">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-indigo-400 uppercase">Host Callsign</label>
                    <input id="dj-name" type="text" class="w-full bg-[#050505] border border-[#333] p-3 text-white focus:border-indigo-500 outline-none rounded-sm font-mono" placeholder="e.g. DJ Vibe">
                </div>
                <button onclick="confirmSetup()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 mt-4 rounded-sm transition tracking-widest">
                    POWER ON
                </button>
            </div>
        </div>
    </div>

    <div id="main-console" class="flex-1 flex flex-col h-full opacity-20 pointer-events-none transition-opacity duration-1000">
        
        <header class="h-16 bg-[#111] border-b-4 border-[#222] flex items-center justify-between px-6 z-50">
            <div class="flex items-center gap-4">
                <div id="on-air-light" class="w-24 h-8 bg-[#220000] border-2 border-[#400] text-[#600] font-black tracking-[0.2em] flex items-center justify-center rounded text-xs shadow-[inset_0_0_10px_#000]">
                    OFF AIR
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-300 tracking-tighter">MIRINDA <span class="text-indigo-500">4000</span></h1>
                    <div class="text-[9px] text-gray-600 font-mono" id="peer-display">STANDBY_MODE</div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="bg-[#050505] px-4 py-1 border border-[#333] rounded-sm font-mono text-green-500 text-lg shadow-[inset_0_0_5px_#000]" id="session-timer">00:00:00</div>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden bg-[#151515]">
            <div class="flex-1 p-6 flex gap-4 overflow-x-auto">
                
                <div class="channel-strip w-40 shrink-0">
                    <div class="screw top-1 left-1"></div><div class="screw top-1 right-1"></div>
                    <div class="text-[10px] font-bold text-indigo-400 mb-4 tracking-widest">VOICE FX</div>
                    
                    <div class="bg-[#111] w-full p-2 rounded mb-4 border border-[#333] flex flex-col gap-3">
                        <div class="flex justify-between items-center"><span class="text-[8px] text-gray-500">HI</span><input id="eqHigh" type="range" class="w-16 h-1" min="-10" max="10" value="0"></div>
                        <div class="flex justify-between items-center"><span class="text-[8px] text-gray-500">MID</span><input id="eqMid" type="range" class="w-16 h-1" min="-10" max="10" value="0"></div>
                        <div class="flex justify-between items-center"><span class="text-[8px] text-gray-500">LO</span><input id="eqLow" type="range" class="w-16 h-1" min="-10" max="10" value="0"></div>
                    </div>

                    <button id="fxReverb" class="w-full py-1 bg-[#222] border border-[#444] text-[9px] text-gray-400 mb-4 hover:bg-indigo-900 hover:text-white transition">REVERB</button>

                    <div class="flex-1 w-full flex justify-center bg-[#111] rounded border border-[#222] py-2">
                        <input id="micVol" type="range" orient="vertical" min="0" max="150" value="100">
                    </div>
                    <button id="micToggle" class="w-full mt-2 py-3 bg-[#131] border border-[#262] text-green-700 font-bold text-xs rounded hover:bg-green-600 hover:text-white transition">MIC LIVE</button>
                </div>

                <div class="channel-strip w-32 shrink-0">
                    <div class="screw top-1 left-1"></div><div class="screw top-1 right-1"></div>
                    <div class="text-[10px] font-bold text-blue-400 mb-4 tracking-widest">MUSIC</div>
                    
                    <div class="bg-black w-full h-20 border border-[#333] mb-2 flex flex-col items-center justify-center p-2">
                        <i class="fas fa-compact-disc text-2xl text-[#333] mb-1" id="deck-icon"></i>
                        <div id="track-name" class="text-[8px] text-gray-300 w-full text-center truncate">Empty</div>
                    </div>
                    
                    <div class="flex gap-1 w-full mb-2">
                        <button onclick="document.getElementById('musicFile').click()" class="flex-1 bg-[#222] text-gray-400 text-[9px] border border-[#333]">LOAD</button>
                        <button id="playBtn" class="flex-1 bg-[#222] text-gray-400 text-[9px] border border-[#333]" disabled>PLAY</button>
                    </div>
                    <input type="file" id="musicFile" hidden accept="audio/*">

                    <div class="flex-1 w-full flex justify-center bg-[#111] rounded border border-[#222] py-2">
                        <input id="musicVol" type="range" orient="vertical" min="0" max="100" value="50">
                    </div>
                    <button id="talkoverBtn" class="w-full mt-2 py-3 bg-[#222] border border-[#333] text-gray-500 font-bold text-xs rounded active:bg-white active:text-black">TALKOVER</button>
                </div>

                <div class="channel-strip w-48 shrink-0 bg-[#18181b] border-l-4 border-indigo-900">
                    <div class="text-[10px] font-bold text-white mb-4 tracking-widest">MASTER OUTPUT</div>
                    <canvas id="scope" class="w-full h-24 bg-black border border-[#333] mb-4 opacity-80"></canvas>
                    
                    <div class="grid grid-cols-2 gap-2 w-full mb-4">
                        <button onclick="playSynth('horn')" class="bg-[#332200] border border-[#664400] text-yellow-600 text-[9px] py-2 font-bold active:bg-yellow-500 active:text-black">HORN</button>
                        <button onclick="playSynth('laugh')" class="bg-[#002233] border border-[#004466] text-blue-600 text-[9px] py-2 font-bold active:bg-blue-500 active:text-black">LAUGH</button>
                    </div>

                    <button id="startBtn" class="w-full py-6 bg-[#222] border-2 border-[#333] rounded mt-auto flex flex-col items-center justify-center hover:bg-[#252525] transition group shadow-[0_5px_15px_rgba(0,0,0,0.5)]">
                        <i class="fas fa-power-off text-2xl text-gray-600 group-hover:text-red-500 mb-1 transition"></i>
                        <span class="text-[10px] font-bold text-gray-500">START TRANSMISSION</span>
                    </button>
                </div>
            </div>

            <div class="w-72 bg-[#0c0c0c] border-l border-[#222] flex flex-col shrink-0">
                <div class="bg-[#151515] p-2 text-[10px] font-bold uppercase tracking-widest text-gray-500 border-b border-[#222]">COMMS LOG <span id="listener-count" class="ml-2 text-white">0</span></div>
                <div id="chat-feed" class="flex-1 overflow-y-auto p-4 space-y-2 scroller font-mono text-xs"></div>
                <div class="p-3 border-t border-[#222] bg-[#111]">
                    <form onsubmit="sendHostMessage(event)" class="flex gap-2">
                        <input id="host-msg" class="flex-1 bg-[#050505] border border-[#333] px-2 py-2 text-xs text-white outline-none font-mono" placeholder="ADMIN_CMD...">
                        <button class="bg-[#222] border border-[#333] text-gray-400 hover:text-white px-3 py-2 text-xs font-bold">TX</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let peer, peerId, audioCtx, masterDest, masterGain, micNode, micGain, musicNode, musicGain, musicEl, analyser, startTime, timerInt, activeCalls = new Map(), listenerCount = 0;
        let stationData = { name: "", dj: "" };
        let selectedMicId = 'default';

        // 1. POPULATE MICS
        navigator.mediaDevices.enumerateDevices().then(devices => {
            const sel = document.getElementById('mic-select');
            sel.innerHTML = '';
            devices.filter(d => d.kind === 'audioinput').forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.deviceId;
                opt.text = d.label || `Microphone ${sel.length + 1}`;
                sel.appendChild(opt);
            });
        });

        function confirmSetup() {
            const sName = document.getElementById('station-name').value;
            const dName = document.getElementById('dj-name').value;
            selectedMicId = document.getElementById('mic-select').value;
            
            if(!sName) return alert("Station Name Required");
            stationData = { name: sName, dj: dName || "Host" };
            
            document.getElementById('setup-modal').classList.add('hidden');
            document.getElementById('main-console').classList.remove('opacity-20', 'pointer-events-none');
        }

        // 2. AUDIO ENGINE
        async function initEngine() {
            if(audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 48000 });
            masterGain = audioCtx.createGain();
            masterDest = audioCtx.createMediaStreamDestination();
            analyser = audioCtx.createAnalyser(); analyser.fftSize = 1024;
            
            // Compressor
            const comp = audioCtx.createDynamicsCompressor();
            comp.threshold.value = -12; comp.ratio.value = 12;
            masterGain.connect(comp); comp.connect(masterDest); comp.connect(analyser);

            micGain = audioCtx.createGain();
            musicGain = audioCtx.createGain(); musicGain.gain.value = 0.5;
            micGain.connect(masterGain); musicGain.connect(masterGain);

            // VOICE FX
            const eqLow = audioCtx.createBiquadFilter(); eqLow.type = 'lowshelf'; eqLow.frequency.value = 320;
            const eqMid = audioCtx.createBiquadFilter(); eqMid.type = 'peaking'; eqMid.frequency.value = 1000;
            const eqHigh = audioCtx.createBiquadFilter(); eqHigh.type = 'highshelf'; eqHigh.frequency.value = 3200;
            
            // Chain: Mic -> Low -> Mid -> High -> Gain
            // Note: In this simplified version, we just connect directly for stability, 
            // but you can chain eqLow.connect(eqMid)... etc.
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { deviceId: selectedMicId, echoCancellation: false, autoGainControl: false, channelCount: 2 } 
                });
                micNode = audioCtx.createMediaStreamSource(stream);
                micNode.connect(micGain);
            } catch(e) { alert("Mic Error: " + e.message); }
            drawScope();
        }

        // 3. BROADCAST
        document.getElementById('startBtn').onclick = async () => {
            if(peerId) return;
            await initEngine();
            if(audioCtx.state === 'suspended') await audioCtx.resume();
            
            const btn = document.getElementById('startBtn');
            btn.classList.replace('bg-[#222]', 'bg-red-900/20'); btn.classList.add('border-red-500'); 
            btn.innerHTML = '<span class="text-red-500 font-bold animate-pulse">TRANSMITTING</span>';
            document.getElementById('on-air-light').className = "w-24 h-8 bg-red-600 text-white font-black flex items-center justify-center rounded text-xs shadow-[0_0_20px_#f00]";
            document.getElementById('on-air-light').innerText = "LIVE";

            peer = new Peer(undefined, { host: location.hostname, port: location.port || 443, path: "/peerjs/peerjs", secure: location.protocol === "https:" });
            
            peer.on('open', (id) => {
                peerId = id;
                document.getElementById('peer-display').innerText = `PID: ${id}`;
                socket.emit('host-ready', { peerId: id, title: stationData.name, hostName: stationData.dj });
            });

            socket.on('new-listener', (id) => {
                if(!activeCalls.has(id)) {
                    const call = peer.call(id, masterDest.stream);
                    activeCalls.set(id, call);
                    listenerCount++;
                    document.getElementById('listener-count').innerText = listenerCount;
                    call.on('close', () => { activeCalls.delete(id); listenerCount--; document.getElementById('listener-count').innerText = listenerCount; });
                }
            });
        };

        // 4. CHAT
        socket.on('chatMessage', (data) => {
            const isMe = data.user === 'HOST';
            const div = document.createElement('div');
            div.className = `mb-1 ${isMe ? 'text-right' : 'text-left'}`;
            div.innerHTML = `<span class="${isMe?'text-indigo-400':'text-gray-400'} font-bold">[${data.user}]</span> <span class="text-gray-300">${data.msg}</span>`;
            document.getElementById('chat-feed').appendChild(div);
        });

        function sendHostMessage(e) {
            e.preventDefault(); const inp = document.getElementById('host-msg'); const txt = inp.value.trim(); if(!txt) return;
            socket.emit('chatMessage', { room: peerId, user: 'HOST', msg: txt });
            const div = document.createElement('div'); div.className = "mb-1 text-right"; div.innerHTML = `<span class="text-indigo-400 font-bold">[HOST]</span> <span class="text-white">${txt}</span>`; document.getElementById('chat-feed').appendChild(div);
            inp.value = '';
        }

        // 5. CONTROLS
        document.getElementById('micVol').oninput = (e) => { if(micGain) micGain.gain.value = e.target.value/100; };
        document.getElementById('musicVol').oninput = (e) => { if(musicGain) musicGain.gain.value = e.target.value/100; };
        document.getElementById('musicFile').onchange = (e) => { const f=e.target.files[0]; if(!f) return; const u=URL.createObjectURL(f); musicEl=new Audio(u); musicEl.crossOrigin='anonymous'; document.getElementById('track-name').innerText=f.name; document.getElementById('playBtn').disabled=false; if(!musicNode&&audioCtx) { musicNode=audioCtx.createMediaElementSource(musicEl); musicNode.connect(musicGain); } };
        document.getElementById('playBtn').onclick = async () => { if(audioCtx.state==='suspended') await audioCtx.resume(); if(musicEl.paused) { musicEl.play(); document.getElementById('deck-icon').classList.add('animate-spin'); } else { musicEl.pause(); document.getElementById('deck-icon').classList.remove('animate-spin'); } };
        
        function playSynth(type) { if(!audioCtx) return; const osc = audioCtx.createOscillator(); const g = audioCtx.createGain(); osc.connect(g); g.connect(masterGain); const now = audioCtx.currentTime; if(type === 'horn') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(300, now + 0.1); g.gain.setValueAtTime(0.5, now); g.gain.exponentialRampToValueAtTime(0.01, now + 0.5); osc.start(now); osc.stop(now+0.5); } }
        function drawScope() { const c=document.getElementById('scope'); const x=c.getContext('2d'); const b=analyser.frequencyBinCount; const d=new Uint8Array(b); function l(){ requestAnimationFrame(l); analyser.getByteTimeDomainData(d); x.fillStyle='#000'; x.fillRect(0,0,c.width,c.height); x.lineWidth=1; x.strokeStyle='#4f46e5'; x.beginPath(); const s=c.width*1.0/b; let p=0; for(let i=0;i<b;i++){ const v=d[i]/128.0; const y=v*c.height/2; if(i===0) x.moveTo(p,y); else x.lineTo(p,y); p+=s; } x.stroke(); } l(); }
    </script>
</body>
</html>