<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Airvibe | Live</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body { background: #050505; color: white; font-family: 'Outfit', sans-serif; overflow: auto; min-height: 100vh; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Smooth Loading */
        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 0.3s, transform 0.3s; }
        
        /* Cards */
        .glass-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(12px); transition: all 0.2s ease; }
        .glass-card:active { transform: scale(0.98); background: rgba(255,255,255,0.08); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom, 20px); }
        
        /* Mini Player Transition */
        #mini-player { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="flex flex-col bg-black">

    <audio id="remoteAudio" autoplay playsinline></audio>

    <div id="view-lobby" class="flex-1 flex flex-col p-4 md:p-6 overflow-y-auto transition-all duration-500 pb-32">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-xl md:text-2xl font-black tracking-tight">AIRVIBE <span class="text-indigo-500">LIVE</span></h1>
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 bg-white/5 px-3 py-1.5 rounded-full border border-white/10">
                    <div id="conn-dot" class="w-2 h-2 rounded-full bg-red-500"></div>
                    <span id="conn-text" class="text-[10px] font-mono text-gray-400">OFFLINE</span>
                </div>
                <div class="w-8 h-8 rounded-full bg-gray-800 overflow-hidden border border-white/20">
                    <img id="user-avatar" src="" class="w-full h-full object-cover">
                </div>
            </div>
        </header>

        <div class="relative mb-6 md:mb-8">
            <i class="fas fa-search absolute left-4 top-3.5 text-gray-500"></i>
            <input id="search-input" type="text" placeholder="Search stations..." 
                class="w-full bg-[#111] border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white focus:border-indigo-500 outline-none transition text-sm"
                onkeyup="filterStreams()">
        </div>

        <h2 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> On Air
        </h2>
        
        <div id="stream-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="col-span-full text-center py-20 text-gray-600">
                <i class="fas fa-circle-notch fa-spin text-2xl mb-2"></i>
                <p class="text-xs">Scanning frequencies...</p>
            </div>
        </div>
    </div>

    <div id="mini-player" class="fixed bottom-0 left-0 right-0 bg-[#111] border-t border-white/10 p-3 pb-6 md:pb-3 flex items-center justify-between z-40 translate-y-full cursor-pointer" onclick="openFullPlayer()">
        <div class="flex items-center gap-3">
            <img id="mini-art" src="" class="w-10 h-10 rounded bg-gray-800 object-cover">
            <div>
                <h4 id="mini-title" class="text-xs font-bold text-white leading-tight">Station Name</h4>
                <p id="mini-host" class="text-[10px] text-gray-400">Host Name</p>
            </div>
        </div>
        <div class="flex items-center gap-4 pr-2">
            <button id="mini-play-btn" class="w-8 h-8 rounded-full border border-white/20 flex items-center justify-center hover:bg-white/10 text-white" onclick="event.stopPropagation(); togglePlay()">
                <i class="fas fa-pause text-xs"></i>
            </button>
        </div>
    </div>

    <div id="view-player" class="fixed inset-0 bg-[#050505] z-50 flex flex-col translate-y-full transition-transform duration-500 ease-out">
        
        <div class="flex justify-between items-center p-6 z-20 bg-gradient-to-b from-black/80 to-transparent">
            <button onclick="closeFullPlayer()" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-white/20 backdrop-blur">
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="text-center">
                <h3 id="player-title" class="font-bold text-lg leading-none tracking-tight">Loading...</h3>
                <p id="player-host" class="text-xs text-indigo-400 font-mono uppercase mt-1">CONNECTING</p>
            </div>
            <button class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-white/20 backdrop-blur">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>

        <div class="flex-1 relative flex flex-col items-center justify-center">
            <canvas id="vis-canvas" class="absolute inset-0 w-full h-full opacity-40 mix-blend-screen"></canvas>
            
            <div class="w-64 h-64 md:w-80 md:h-80 rounded-full bg-[#1a1a2e] border border-white/10 shadow-[0_0_60px_rgba(79,70,229,0.2)] flex items-center justify-center relative z-10 overflow-hidden">
                <img id="player-art" src="" class="w-full h-full object-cover opacity-80">
                <div class="absolute inset-0 bg-black/20"></div>
                <i class="fas fa-music text-6xl text-white/50 absolute z-20"></i>
            </div>
            
            <button id="big-play-btn" onclick="togglePlay()" class="absolute z-30 w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-xl hidden">
                <i class="fas fa-play text-black text-3xl ml-1"></i>
            </button>
        </div>

        <div class="h-[40vh] bg-[#0a0a0a] border-t border-white/10 flex flex-col rounded-t-[2.5rem] relative z-20 shadow-2xl">
            <div id="chat-feed" class="flex-1 overflow-y-auto p-6 space-y-3 no-scrollbar text-sm"></div>
            
            <div class="p-4 safe-pb border-t border-white/5 flex gap-2 items-center bg-[#0a0a0a]">
                <button onclick="sendGift('üî•')" class="text-xl hover:scale-110 transition p-2">üî•</button>
                <button onclick="sendGift('‚ù§Ô∏è')" class="text-xl hover:scale-110 transition p-2">‚ù§Ô∏è</button>
                <input id="chat-inp" type="text" class="flex-1 bg-[#151515] border border-white/10 rounded-full px-4 h-10 text-white focus:outline-none focus:border-indigo-500 transition placeholder-gray-600 text-sm" placeholder="Say something..." autocomplete="off">
                <button onclick="sendChat()" class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white hover:bg-indigo-500 transition shadow-lg">
                    <i class="fas fa-paper-plane text-xs"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        const socket = io();
        let peer, myId, currentRoomId;
        let activeStreams = [];
        let audioCtx, analyser, gainNode;
        let isConnected = false;

        // --- 1. PROFILE INIT ---
        const myName = localStorage.getItem('av_name') || `Guest${Math.floor(Math.random()*900)}`;
        const myAvatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${myName}`;
        document.getElementById('user-avatar').src = myAvatar;

        // --- 2. NETWORK ---
        socket.on('connect', () => {
            isConnected = true;
            document.getElementById('conn-text').innerText = "ONLINE";
            document.getElementById('conn-dot').classList.replace('bg-red-500', 'bg-green-500');
            document.getElementById('conn-text').classList.add('text-green-500');
            socket.emit('request-stream-list');
        });

        socket.on('disconnect', () => {
            isConnected = false;
            document.getElementById('conn-text').innerText = "OFFLINE";
            document.getElementById('conn-dot').classList.replace('bg-green-500', 'bg-red-500');
            document.getElementById('conn-text').classList.remove('text-green-500');
        });

        // Initialize PeerJS
        peer = new Peer(undefined, { 
            host: location.hostname, 
            port: location.port || 443, 
            path: "/peerjs", 
            secure: location.protocol === "https:" 
        });
        
        peer.on('open', id => { myId = id; console.log("My Peer ID:", id); });

        // --- 3. STREAM DISCOVERY ---
        socket.on('stream-list', (streams) => {
            if (activeStreams.length !== streams.length) {
                activeStreams = streams;
                renderStreams(streams);
            } else {
                activeStreams = streams;
            }
        });

        function renderStreams(streams) {
            const grid = document.getElementById('stream-grid');
            grid.innerHTML = '';
            // only show truly live streams (defensive)
            const live = (streams || []).filter(s => s && s.startedAt);
            
            if(live.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-20 opacity-50">
                        <i class="fas fa-satellite-dish text-4xl text-gray-700 mb-2"></i>
                        <p class="text-sm text-gray-500">No signals detected.</p>
                    </div>`;
                return;
            }

            // sort by newest first
            live.sort((a,b) => (b.startedAt||0) - (a.startedAt||0));

            live.forEach(stream => {
                const card = document.createElement('div');
                card.className = "glass-card p-4 rounded-2xl flex items-center gap-4 cursor-pointer hover:bg-white/5 active:scale-95 fade-enter";
                card.onclick = () => joinStream(stream);
                
                requestAnimationFrame(() => card.classList.add('fade-enter-active'));
                
                const artSeed = stream.title.replace(/\s/g, '');
                
                card.innerHTML = `
                    <div class="w-14 h-14 rounded-xl bg-gray-900 overflow-hidden relative shrink-0">
                        <img src="https://api.dicebear.com/7.x/shapes/svg?seed=${artSeed}" class="w-full h-full object-cover opacity-80">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <i class="fas fa-play text-white drop-shadow-md text-xs"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-base text-white truncate">${stream.title}</h3>
                        <p class="text-xs text-gray-400 truncate">${stream.hostName}</p>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="text-[9px] font-bold text-red-500 bg-red-900/20 px-2 py-0.5 rounded border border-red-900/30">LIVE</span>
                        <span class="text-[9px] text-gray-500"><i class="fas fa-users"></i> ${stream.listeners || 0}</span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function filterStreams() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filtered = activeStreams.filter(s => 
                s.title.toLowerCase().includes(query) || 
                s.hostName.toLowerCase().includes(query)
            );
            renderStreams(filtered);
        }

        // --- 4. PLAYER LOGIC ---
        function joinStream(stream) {
            currentRoomId = stream.peerId;
            
            // UI Updates
            document.getElementById('player-title').innerText = stream.title;
            document.getElementById('player-host').innerText = stream.hostName;
            document.getElementById('mini-title').innerText = stream.title;
            document.getElementById('mini-host').innerText = stream.hostName;
            
            const artUrl = `https://api.dicebear.com/7.x/shapes/svg?seed=${stream.title.replace(/\s/g, '')}`;
            document.getElementById('player-art').src = artUrl;
            document.getElementById('mini-art').src = artUrl;
            document.getElementById('chat-feed').innerHTML = `<div class="text-center text-[10px] text-gray-600 mt-4">Connected to ${stream.title}</div>`;
            
            // Show Full Player
            document.getElementById('view-player').classList.remove('translate-y-full');
            document.getElementById('mini-player').classList.remove('translate-y-full'); // Show mini bar
            
            // Connect Sockets
            if(isConnected) {
                socket.emit('join-stream', currentRoomId);
                socket.emit('listener-ready', myId);
                socket.emit('chatMessage', { room: currentRoomId, user: 'SYSTEM', msg: `${myName} joined`, type: 'system' });
            }
            
            // Init Audio (Requires interaction)
            initAudioContext();
        }

        function openFullPlayer() {
            document.getElementById('view-player').classList.remove('translate-y-full');
        }

        function closeFullPlayer() {
            document.getElementById('view-player').classList.add('translate-y-full');
        }

        function leaveStream() {
            closeFullPlayer();
            document.getElementById('mini-player').classList.add('translate-y-full');
            const audio = document.getElementById('remoteAudio');
            audio.pause();
            audio.srcObject = null;
            setTimeout(() => { if(audioCtx) audioCtx.suspend(); }, 500);
        }

        // Audio Controls
        function togglePlay() {
            const audio = document.getElementById('remoteAudio');
            const miniBtn = document.getElementById('mini-play-btn');
            const bigBtn = document.getElementById('big-play-btn');
            
            if (audio.paused) {
                audio.play();
                miniBtn.innerHTML = '<i class="fas fa-pause text-xs"></i>';
                bigBtn.classList.add('hidden');
            } else {
                audio.pause();
                miniBtn.innerHTML = '<i class="fas fa-play text-xs"></i>';
                bigBtn.classList.remove('hidden');
            }
        }

        // Receive Audio Stream
        peer.on('call', (call) => {
            call.answer();
            call.on('stream', (stream) => {
                const audio = document.getElementById('remoteAudio');
                audio.srcObject = stream;
                audio.play().catch(e => {
                    console.log("Autoplay blocked");
                    document.getElementById('big-play-btn').classList.remove('hidden');
                });
                setupVisualizer(stream);
            });
        });

        // --- 5. CHAT SYSTEM ---
        socket.on('chatMessage', (data) => {
            const div = document.createElement('div');
            const isMe = data.user === myName;
            div.className = isMe ? "text-right mb-2" : "text-left mb-2";
            
            const bgClass = isMe ? 'bg-indigo-600 text-white' : 'bg-[#1a1a1a] border border-white/10 text-gray-300';
            const userColor = data.user === 'HOST' ? 'text-red-400' : 'text-indigo-400';

            div.innerHTML = `
                <div class="inline-block max-w-[85%]">
                    <span class="text-[9px] ${userColor} font-bold block mb-0.5 ml-1">${data.user}</span>
                    <span class="${bgClass} px-3 py-1.5 rounded-2xl ${isMe ? 'rounded-tr-sm' : 'rounded-tl-sm'} text-xs inline-block">
                        ${data.msg}
                    </span>
                </div>
            `;
            const feed = document.getElementById('chat-feed');
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        });

        function sendChat() {
            const inp = document.getElementById('chat-inp');
            const txt = inp.value.trim();
            if(!txt || !currentRoomId) return;
            
            const div = document.createElement('div');
            div.className = "text-right mb-2";
            div.innerHTML = `
                <div class="inline-block max-w-[85%]">
                    <span class="text-[9px] text-gray-500 font-bold block mb-0.5 ml-1">Me</span>
                    <span class="bg-indigo-600 text-white px-3 py-1.5 rounded-2xl rounded-tr-sm text-xs inline-block">${txt}</span>
                </div>`;
            document.getElementById('chat-feed').appendChild(div);
            document.getElementById('chat-feed').scrollTop = document.getElementById('chat-feed').scrollHeight;

            socket.emit('chatMessage', { room: currentRoomId, user: myName, msg: txt });
            inp.value = '';
        }

        function sendGift(icon) {
            if(!currentRoomId) return;
            socket.emit('sendGift', { room: currentRoomId, user: myName, gift: icon });
            confetti({ particleCount: 30, spread: 50, origin: { y: 0.8 } });
        }

        // --- 6. VISUALIZER ---
        function initAudioContext() {
            if(audioCtx && audioCtx.state === 'running') return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            gainNode = audioCtx.createGain();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 64;
        }

        function setupVisualizer(stream) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            
            const src = audioCtx.createMediaStreamSource(stream);
            src.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            src.connect(analyser);
            
            const canvas = document.getElementById('vis-canvas');
            const ctx = canvas.getContext('2d');
            const data = new Uint8Array(analyser.frequencyBinCount);
            
            function draw() {
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(data);
                ctx.clearRect(0,0,canvas.width,canvas.height);
                
                const w = canvas.width / data.length;
                data.forEach((val, i) => {
                    const h = (val/255) * canvas.height;
                    ctx.fillStyle = `rgba(99, 102, 241, ${val/300})`;
                    ctx.fillRect(i*w, (canvas.height-h)/2, w-1, h);
                });
            }
            draw();
        }
    </script>
</body>
</html>