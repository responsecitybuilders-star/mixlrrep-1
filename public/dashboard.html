<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Airvibe | Studio Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { bg: '#09090b', panel: '#18181b', border: '#27272a', primary: '#6366f1', danger: '#ef4444' } } }
        }
    </script>
    <style>
        body { background-color: #09090b; color: #e4e4e7; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }
        .glass-panel { background: rgba(24, 24, 27, 0.8); backdrop-filter: blur(12px); border: 1px solid #27272a; }
        .scroll-y { overflow-y: auto; scrollbar-width: thin; scrollbar-color: #3f3f46 transparent; }
        
        /* Custom Sliders */
        input[type=range] { width: 100%; height: 6px; background: #27272a; border-radius: 3px; -webkit-appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #6366f1; border-radius: 50%; cursor: pointer; border: 2px solid #fff; }
        
        /* Animations */
        .live-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .rec-active { animation: blink-red 1s infinite; background-color: #ef4444; color: white; border-color: #ef4444; }
        @keyframes blink-red { 50% { opacity: 0.5; } }
    </style>
</head>
<body class="flex flex-col">

    <header class="h-16 border-b border-border bg-bg/90 backdrop-blur flex items-center justify-between px-6 z-50">
        <div class="flex items-center gap-3 font-black text-lg tracking-tight">
            <div class="w-3 h-3 bg-primary rotate-45"></div> AIRVIBE <span class="text-xs bg-zinc-800 px-2 py-1 rounded text-zinc-400 font-mono">PRO</span>
        </div>
        <div class="hidden md:flex gap-6 font-mono text-xs text-zinc-500">
            <span>CPU: <b class="text-white">STABLE</b></span>
            <span>STATUS: <b id="engine-status" class="text-yellow-500">READY</b></span>
            <span>REC: <b id="rec-size" class="text-white">0.0 MB</b></span>
        </div>
        <div class="flex gap-3">
            <div id="rec-badge" class="hidden px-3 py-1 bg-red-900/30 border border-red-500 rounded text-xs font-bold text-red-500 flex items-center gap-2">
                <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div> REC
            </div>
            <div id="status-badge" class="px-3 py-1 bg-black border border-zinc-800 rounded text-xs font-bold text-zinc-500">‚óè OFFLINE</div>
        </div>
    </header>

    <div class="flex-1 grid grid-cols-1 lg:grid-cols-[320px_1fr_350px] overflow-hidden">
        
        <div class="border-r border-border bg-panel p-5 scroll-y flex flex-col gap-6">
            <div>
                <label class="text-xs font-bold text-zinc-500 mb-2 block">BROADCAST DETAILS</label>
                <input id="stream-title" class="w-full bg-black border border-border rounded p-2 text-sm text-white mb-2 focus:border-primary outline-none" value="My Live Session">
                <select id="audio-source" class="w-full bg-zinc-900 border border-border rounded p-2 text-xs text-white outline-none"></select>
            </div>

            <div class="bg-black p-4 rounded-lg border border-border">
                <div class="flex justify-between mb-1"><span class="text-xs font-bold text-zinc-400">MICROPHONE GAIN</span> <span id="gain-val" class="text-xs text-primary">100%</span></div>
                <input type="range" min="0" max="200" value="100" oninput="setGain(this.value)">
            </div>

            <div>
                <label class="text-xs font-bold text-zinc-500 mb-2 block">VOICE FX RACK</label>
                <div class="grid grid-cols-2 gap-2">
                    <button class="p-2 bg-zinc-900 border border-border rounded text-xs font-bold hover:bg-zinc-800 transition" onclick="setFX('normal')">üéôÔ∏è Clean</button>
                    <button class="p-2 bg-zinc-900 border border-border rounded text-xs font-bold hover:bg-zinc-800 transition" onclick="setFX('radio')">üìª Radio</button>
                    <button class="p-2 bg-zinc-900 border border-border rounded text-xs font-bold hover:bg-zinc-800 transition" onclick="setFX('robot')">ü§ñ Robot</button>
                    <button class="p-2 bg-zinc-900 border border-border rounded text-xs font-bold hover:bg-zinc-800 transition" onclick="setFX('echo')">üì¢ Echo</button>
                </div>
            </div>

            <div class="mt-auto">
                <label class="text-xs font-bold text-zinc-500 mb-2 block">MUSIC BED</label>
                <div class="flex items-center gap-3 bg-zinc-900 p-2 rounded mb-3 border border-border cursor-pointer hover:border-primary" onclick="document.getElementById('bgm-input').click()">
                    <div class="w-8 h-8 bg-zinc-800 rounded flex items-center justify-center">üéµ</div>
                    <div class="text-xs font-bold truncate flex-1" id="track-name">Load Track...</div>
                </div>
                <input type="file" id="bgm-input" class="hidden" onchange="loadBGM(this)">
                <div class="flex gap-2 mb-2">
                    <button onclick="toggleBGM()" class="flex-1 bg-zinc-800 p-1 rounded text-xs font-bold hover:bg-white hover:text-black">‚èØ Play</button>
                </div>
                <input type="range" min="0" max="100" value="30" oninput="setBGMVol(this.value)">
            </div>
        </div>

        <div class="relative bg-black flex flex-col">
            <canvas id="visualizer" class="absolute inset-0 w-full h-full opacity-50"></canvas>
            
            <div class="z-10 flex-1 flex flex-col items-center justify-center gap-8">
                <div class="text-center">
                    <div class="text-5xl font-black tracking-tighter tabular-nums text-white" id="timer">00:00:00</div>
                    <div class="text-xs font-mono text-zinc-600 tracking-[0.3em] mt-2">SESSION DURATION</div>
                </div>

                <button id="go-live-btn" onclick="toggleBroadcast()" class="w-40 h-40 rounded-full border-4 border-zinc-800 bg-zinc-900 flex flex-col items-center justify-center hover:scale-105 hover:border-primary hover:text-white transition-all shadow-2xl group">
                    <span class="text-3xl font-black group-hover:text-primary transition" id="btn-text">GO</span>
                    <span class="text-xs font-bold tracking-widest text-zinc-500" id="btn-sub">LIVE</span>
                </button>

                <div class="flex gap-4">
                    <button onclick="toggleMute()" id="mute-btn" class="w-12 h-12 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center hover:bg-white hover:text-black transition" title="Mute Mic">üîá</button>
                    <button onclick="toggleRecording()" id="rec-btn" class="w-12 h-12 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center hover:bg-red-500 hover:text-white transition" title="Start Recording">üî¥</button>
                </div>
            </div>

            <div class="z-10 h-12 border-t border-border bg-bg/80 backdrop-blur flex justify-between items-center px-6 text-xs font-mono">
                <span class="text-zinc-500">LISTENERS: <b class="text-white text-sm" id="listener-count">0</b></span>
            </div>
        </div>

        <div class="border-l border-border bg-panel flex flex-col">
            <div class="p-4 border-b border-border bg-zinc-900/50">
                <div class="text-xs font-bold text-zinc-500 mb-2">REVENUE</div>
                <div class="text-3xl font-black text-yellow-400" id="revenue-total">$0.00</div>
            </div>

            <div class="flex-1 scroll-y p-0 flex flex-col gap-0" id="chat-feed">
                <div class="p-4 text-center text-xs text-zinc-600 mt-10">Room initialized.<br>System Ready.</div>
            </div>

            <div class="p-3 border-t border-border bg-zinc-900">
                <div class="flex gap-2 mb-2">
                    <input id="chat-input" class="flex-1 bg-black border border-border rounded p-2 text-sm text-white outline-none focus:border-primary" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendChat()">
                    <button onclick="sendChat()" class="px-4 bg-primary rounded font-bold text-sm hover:bg-indigo-500">Send</button>
                </div>
            </div>
        </div>

    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        
        // GLOBAL STATE
        let audioCtx, micSource, micGain, bgmSource, bgmGain, masterDest;
        let mediaRecorder, recordedChunks = [];
        let isLive = false, isRecording = false;
        let startTime, timerInterval;
        let bgmAudio = new Audio(); bgmAudio.loop = true;

        // --- 1. CORE ENGINE ---
        async function toggleBroadcast() {
            if (isLive) {
                stopBroadcast();
            } else {
                try {
                    // Force AudioContext (Fixes "Not Going Live")
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    audioCtx = new AudioContext();
                    await audioCtx.resume(); 

                    // Audio Graph
                    masterDest = audioCtx.createMediaStreamDestination();
                    micGain = audioCtx.createGain();
                    bgmGain = audioCtx.createGain(); bgmGain.gain.value = 0.3;

                    // Mic
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    micSource = audioCtx.createMediaStreamSource(stream);
                    micSource.connect(micGain);
                    micGain.connect(masterDest); // Stream Path
                    
                    // Visuals
                    setupVisualizer(masterDest.stream);

                    // Server
                    const title = document.getElementById('stream-title').value;
                    socket.emit('broadcaster', { title: title, host: 'Host' });

                    // UI
                    isLive = true;
                    updateUI(true);
                    startTimer();
                    addLog("SYSTEM", "üéôÔ∏è Broadcast Started", "sys");

                    // WebRTC Peer
                    socket.on('watcher', id => {
                        const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                        masterDest.stream.getTracks().forEach(t => pc.addTrack(t, masterDest.stream));
                        pc.onicecandidate = e => { if(e.candidate) socket.emit('candidate', id, e.candidate); };
                        pc.createOffer().then(d => pc.setLocalDescription(d)).then(() => socket.emit('offer', id, pc.localDescription));
                        socket.on('answer', (sid, desc) => { if(sid===id) pc.setRemoteDescription(desc); });
                        socket.on('candidate', (sid, cand) => { if(sid===id) pc.addIceCandidate(new RTCPeerConnection(cand)); });
                    });

                } catch (e) {
                    alert("‚ö†Ô∏è Mic Error: " + e.message + "\nPlease click 'Allow' on the popup.");
                }
            }
        }

        function stopBroadcast() {
            if(isRecording) toggleRecording();
            socket.emit('stopBroadcast');
            alert("Broadcast Ended.");
            location.reload(); // Hard reset
        }

        // --- 2. RECORDING (ROBUST) ---
        function toggleRecording() {
            if(!isLive) return alert("‚ö†Ô∏è You must be LIVE to record.");

            if (!isRecording) {
                // START
                recordedChunks = [];
                // Browser Compatibility Check
                const types = ["audio/webm", "audio/ogg", "audio/mp4"];
                const mimeType = types.find(type => MediaRecorder.isTypeSupported(type)) || "";
                
                if(!mimeType) return alert("‚ùå Browser does not support audio recording.");

                mediaRecorder = new MediaRecorder(masterDest.stream, { mimeType });
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = saveFile;
                mediaRecorder.start(1000); // 1s chunks
                
                isRecording = true;
                document.getElementById('rec-btn').classList.add('rec-active');
                document.getElementById('rec-badge').classList.remove('hidden');
                addLog("SYSTEM", "üî¥ Recording Started", "sys");

                // Update Size
                window.recInterval = setInterval(() => {
                    const size = (recordedChunks.length * 0.05).toFixed(1); // Approx
                    document.getElementById('rec-size').innerText = size + " MB";
                }, 1000);

            } else {
                // STOP
                mediaRecorder.stop();
                isRecording = false;
                clearInterval(window.recInterval);
                document.getElementById('rec-btn').classList.remove('rec-active');
                document.getElementById('rec-badge').classList.add('hidden');
            }
        }

        function saveFile() {
            // Buffer wait
            setTimeout(() => {
                const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `airvibe_rec_${Date.now()}.${mediaRecorder.mimeType.split('/')[1].split(';')[0]}`;
                a.click();
                addLog("SYSTEM", "üíæ Recording Saved", "sys");
            }, 100);
        }

        // --- 3. UTILS & UI ---
        function updateUI(live) {
            const btnText = document.getElementById('btn-text');
            const btnSub = document.getElementById('btn-sub');
            const badge = document.getElementById('status-badge');
            const btn = document.getElementById('go-live-btn');

            if(live) {
                btnText.innerText = "END";
                btnSub.innerText = "STREAM";
                btn.classList.add('live-pulse', 'border-red-500', 'bg-red-900/20');
                badge.className = "px-3 py-1 bg-red-900/30 border border-red-500 rounded text-xs font-bold text-red-500 animate-pulse";
                badge.innerText = "‚óè ON AIR";
                document.getElementById('engine-status').innerText = "LIVE";
                document.getElementById('engine-status').className = "text-green-500 animate-pulse";
            }
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const diff = Date.now() - startTime;
                const date = new Date(diff);
                const str = date.toISOString().substr(11, 8);
                document.getElementById('timer').innerText = str;
            }, 1000);
        }

        // --- 4. AUDIO HELPERS ---
        function setGain(val) { if(micGain) micGain.gain.value = val/100; document.getElementById('gain-val').innerText = val+'%'; }
        
        function loadBGM(input) {
            if(input.files[0]) {
                const file = input.files[0];
                document.getElementById('track-name').innerText = file.name;
                bgmAudio.src = URL.createObjectURL(file);
                if(audioCtx && !bgmSource) {
                    bgmSource = audioCtx.createMediaElementSource(bgmAudio);
                    bgmSource.connect(bgmGain).connect(masterDest);
                }
            }
        }
        function toggleBGM() { bgmAudio.paused ? bgmAudio.play() : bgmAudio.pause(); }
        function setBGMVol(val) { bgmAudio.volume = val/100; }

        // --- 5. CHAT ---
        function sendChat() {
            const input = document.getElementById('chat-input');
            const txt = input.value;
            if(!txt) return;
            addLog("HOST", txt);
            socket.emit('chatMessage', { room: socket.id, user: 'HOST', msg: txt });
            input.value = '';
        }

        function addLog(user, txt, type='') {
            const feed = document.getElementById('chat-feed');
            const div = document.createElement('div');
            div.className = `chat-msg ${type === 'sys' ? 'bg-zinc-800/50 border-l-2 border-yellow-500' : 'border-b border-zinc-800'} p-2 text-sm text-zinc-300`;
            div.innerHTML = `<b>${user}:</b> ${txt}`;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        socket.on('chatMessage', data => addLog(data.user||'Guest', data.msg));
        socket.on('roomLog', data => { if(data.type === 'join') document.getElementById('listener-count').innerText = data.count; });

        // --- 6. VISUALIZER ---
        function setupVisualizer(stream) {
            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');
            const analyser = audioCtx.createAnalyser();
            const source = audioCtx.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 64;
            const dataArray = new Uint8Array(analyser.frequencyBinCount);

            function draw() {
                if(!isLive) return;
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);
                canvas.width = canvas.parentElement.offsetWidth;
                canvas.height = canvas.parentElement.offsetHeight;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const barWidth = (canvas.width / dataArray.length) * 2.5;
                let x = 0;
                for(let i = 0; i < dataArray.length; i++) {
                    const barHeight = dataArray[i] * 1.5;
                    ctx.fillStyle = `rgb(${barHeight+50}, 100, 255)`;
                    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            }
            draw();
        }

        // Init Audio Options
        navigator.mediaDevices.enumerateDevices().then(d => {
            const sel = document.getElementById('audio-source');
            d.filter(x=>x.kind==='audioinput').forEach(i => sel.innerHTML += `<option value="${i.deviceId}">${i.label || 'Mic ' + (sel.length+1)}</option>`);
        });
    </script>
</body>
</html>