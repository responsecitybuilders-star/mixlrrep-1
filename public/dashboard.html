<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Airvibe | Ultimate Listener V9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body { background: #000; color: white; font-family: 'Outfit', sans-serif; overflow: hidden; height: 100vh; width: 100vw; }
        .glass { background: rgba(10, 10, 12, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.08); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .float-emoji { position: absolute; pointer-events: none; animation: floatUp 2s ease-out forwards; font-size: 24px; z-index: 50; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-150px) scale(1.5); opacity: 0; } }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom, 20px); }
    </style>
</head>
<body class="flex flex-col relative bg-gradient-to-br from-black via-[#050505] to-[#111]">

    <audio id="remoteAudio" autoplay playsinline></audio>

    <div id="overlay" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center p-6 transition-opacity duration-500">
        <div class="relative mb-8 group">
            <div class="absolute inset-0 bg-indigo-500/30 blur-3xl rounded-full animate-pulse group-hover:bg-indigo-500/50 transition"></div>
            <div class="w-32 h-32 rounded-full border border-white/10 bg-[#080808] flex items-center justify-center relative z-10">
                <i class="fas fa-headphones-simple text-4xl text-white"></i>
            </div>
        </div>
        <h1 class="text-3xl font-black mb-1">AIRVIBE <span class="text-indigo-500">V9</span></h1>
        <p id="conn-status" class="text-gray-500 mb-8 font-mono text-xs uppercase tracking-widest">Searching for Host...</p>
        <button id="tune-in-btn" onclick="startEngine()" class="w-full max-w-[200px] bg-white text-black font-bold py-4 rounded-full shadow-[0_0_30px_rgba(255,255,255,0.2)] active:scale-95 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>TUNE IN</button>
    </div>

    <div id="ui-layer" class="flex-1 flex flex-col h-full opacity-0 pointer-events-none transition-opacity duration-700">
        <header class="h-14 flex items-center justify-between px-4 z-20 bg-gradient-to-b from-black/80 to-transparent">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-gray-800 border border-white/10 overflow-hidden">
                  <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Host" class="w-full h-full object-cover">
                </div>
                <div class="flex flex-col">
                  <span class="text-xs font-bold leading-none">LIVE HOST</span>
                  <div class="flex items-center gap-1 mt-0.5">
                    <div id="live-dot" class="w-1.5 h-1.5 rounded-full bg-gray-500"></div>
                    <span id="live-text" class="text-[9px] font-mono text-gray-500 uppercase">OFFLINE</span>
                  </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-1 bg-white/5 px-2 py-1 rounded text-[10px] font-mono border border-white/5">
                  <i class="fas fa-signal text-green-500"></i><span id="ping-stat">--ms</span>
                </div>
                <div class="flex items-center gap-1 bg-white/5 px-2 py-1 rounded text-[10px] font-mono border border-white/5">
                  <i class="fas fa-user text-indigo-400"></i><span id="listener-count">0</span>
                </div>
            </div>
        </header>

        <div class="flex-1 relative flex flex-col items-center justify-center cursor-pointer" onclick="toggleVisMode()">
            <canvas id="vis-canvas" class="absolute inset-0 w-full h-full opacity-60"></canvas>
            <div class="relative z-10 text-center pointer-events-none">
                <h2 class="text-2xl font-bold tracking-tight mb-1 drop-shadow-lg">Now Playing</h2>
                <p class="text-indigo-400 text-sm font-mono">Airvibe Radio</p>
            </div>
            <div class="absolute inset-0 z-0" ondblclick="sendReaction('â¤ï¸')"></div>
        </div>

        <div class="glass flex flex-col rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.5)] h-[45vh] max-h-[400px]">
            <div class="flex items-center justify-center gap-6 py-2 border-b border-white/5">
                <button onclick="toggleAudioBoost()" class="text-xs text-gray-400 hover:text-white flex flex-col items-center gap-1"><i class="fas fa-volume-high"></i> <span class="text-[9px]">BOOST</span></button>
                <button onclick="toggleSleepTimer()" class="text-xs text-gray-400 hover:text-white flex flex-col items-center gap-1"><i class="fas fa-moon"></i> <span class="text-[9px]">SLEEP</span></button>
                <button onclick="shareStation()" class="text-xs text-gray-400 hover:text-white flex flex-col items-center gap-1"><i class="fas fa-share-nodes"></i> <span class="text-[9px]">SHARE</span></button>
                <button onclick="reloadAudio()" class="text-xs text-gray-400 hover:text-white flex flex-col items-center gap-1"><i class="fas fa-rotate"></i> <span class="text-[9px]">RELOAD</span></button>
            </div>

            <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar relative">
                <div class="absolute inset-0 pointer-events-none bg-gradient-to-t from-black/20 to-transparent"></div>
                <div class="text-center text-[10px] text-gray-600 mt-4">-- Global Chat Connected --</div>
            </div>

            <div class="p-3 pb-6 safe-pb bg-black/40">
                <div class="absolute -top-12 right-4 flex gap-2">
                    <button onclick="sendGift('ðŸ”¥')" class="w-10 h-10 rounded-full bg-gray-800/80 backdrop-blur border border-white/10 text-lg shadow-lg active:scale-90 transition">ðŸ”¥</button>
                    <button onclick="sendGift('ðŸš€')" class="w-10 h-10 rounded-full bg-indigo-600/80 backdrop-blur border border-indigo-400 text-lg shadow-lg active:scale-90 transition">ðŸš€</button>
                </div>
                <form onsubmit="sendMessage(event)" class="flex gap-2">
                    <div class="relative flex-1">
                        <input id="msg-input" type="text" class="w-full bg-[#1a1a1a] border border-white/10 rounded-full pl-4 pr-10 h-10 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500 transition" placeholder="Say something..." autocomplete="off">
                        <i class="fas fa-smile absolute right-3 top-3 text-gray-500 text-xs"></i>
                    </div>
                    <button type="submit" class="w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center hover:bg-indigo-500 active:scale-95 transition"><i class="fas fa-paper-plane text-xs"></i></button>
                </form>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-white text-black px-4 py-2 rounded-full text-xs font-bold shadow-xl translate-y-[-100px] transition duration-300 z-[200]">Notification</div>

   <script>
    const socket = io();
    const audio = document.getElementById('remoteAudio');
    let peer, myId, audioCtx, analyser, gainNode, isBoosted = false, visMode = 0, pingStart;
    let hostPeerId = null;
    let typingTimeout;

    // âœ… User Configuration
    const MY_NAME = localStorage.getItem('airvibe-username') || `Guest${Math.floor(1000 + Math.random() * 9000)}`;
    const MY_COLOR = '#3b82f6';
    let isTyping = false;

    // âœ… Join global chat on load
    function joinGlobalChat() {
        socket.emit('user-join', {
            name: MY_NAME,
            isHost: false,
            role: 'listener'
        });
    }

    function startEngine() {
        document.getElementById('overlay').classList.add('opacity-0', 'pointer-events-none');
        document.getElementById('ui-layer').classList.remove('opacity-0', 'pointer-events-none');

        // Join global chat
        joinGlobalChat();

        initAudioContext();

        peer = new Peer(undefined, {
          host: location.hostname,
          port: location.port || 443,
          path: "/peerjs/peerjs",
          secure: location.protocol === "https:"
        });

        peer.on('open', (id) => {
            myId = id;

            // âœ… tell server we are ready to receive the call
            socket.emit('listener-ready', id);

            setInterval(() => {
              if(document.getElementById('live-text').innerText === "LIVE") {
                socket.emit('listener-ready', myId);
              }
            }, 5000);
        });

        peer.on('call', (call) => {
            call.answer();
            call.on('stream', (stream) => {
                // audio graph for boost/visual
                if(audioCtx) {
                  const source = audioCtx.createMediaStreamSource(stream);
                  source.connect(gainNode);
                  gainNode.connect(audioCtx.destination);
                  setupVisualizer(source);
                }

                audio.srcObject = stream;
                audio.play().catch(() => showToast("Tap to Unmute!"));
            });
        });
    }

    socket.on('connect', () => {
      document.getElementById('conn-status').innerText = "Connected. Waiting for Host...";
      pingStart = Date.now();
      socket.emit('requestData');
    });

    socket.on('pong', () => document.getElementById('ping-stat').innerText = (Date.now() - pingStart) + 'ms');

    socket.on('host-status', (data) => {
        const btn = document.getElementById('tune-in-btn');

        hostPeerId = data.hostPeerId || null;
        
        // Update online count
        document.getElementById('listener-count').innerText = data.onlineCount || 0;

        if(data.live) {
            btn.disabled = false;
            document.getElementById('conn-status').innerText = "ðŸŸ¢ Host is LIVE";
            document.getElementById('conn-status').classList.add('text-green-500');
            document.getElementById('live-dot').className = "w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse";
            document.getElementById('live-text').innerText = "LIVE";
            document.getElementById('live-text').className = "text-[9px] font-mono text-red-500 font-bold uppercase";

            addChatBubble("SYSTEM", "Host is LIVE ðŸŽ¤", false, true, "#ef4444");
        } else {
            btn.disabled = true;
            document.getElementById('conn-status').innerText = "Host is Offline";
            document.getElementById('conn-status').classList.remove('text-green-500');
            document.getElementById('live-dot').className = "w-1.5 h-1.5 rounded-full bg-gray-500";
            document.getElementById('live-text').innerText = "OFFLINE";
            document.getElementById('live-text').className = "text-[9px] font-mono text-gray-500 uppercase";

            addChatBubble("SYSTEM", "Host went offline âš ï¸", false, true, "#ef4444");
        }
    });

    // âœ… Receive chat history
    socket.on('chat-history', (history) => {
        const chatBox = document.getElementById('chat-box');
        chatBox.innerHTML = '<div class="text-center text-[10px] text-gray-600 mt-4">-- Global Chat Connected --</div>';
        
        history.forEach(msg => {
            const isMe = msg.user === MY_NAME;
            const isHost = msg.type === 'host';
            const isSystem = msg.type === 'system';
            
            addChatBubble(msg.user, msg.msg, isMe, isHost, isSystem ? '#fbbf24' : (isHost ? '#ef4444' : msg.color || '#3b82f6'));
        });
    });

    // âœ… Receive chat messages
    socket.on('chatMessage', (data) => {
        const isMe = data.user === MY_NAME;
        const isHost = data.type === 'host';
        const isSystem = data.type === 'system' || data.user === 'SYSTEM';
        const color = isSystem ? '#fbbf24' : (isHost ? '#ef4444' : data.color || '#3b82f6');
        
        addChatBubble(data.user, data.msg, isMe, isHost, color, isSystem);
        
        // Play sound for new messages (except your own)
        if (!isMe) {
            playMessageSound();
        }
    });

    // âœ… Receive online users
    socket.on('online-users', (users) => {
        const hostCount = users.filter(u => u.isHost).length;
        const listenerCount = users.filter(u => !u.isHost).length;
        
        document.getElementById('listener-count').innerText = users.length;
        
        // Update status indicator
        const statusEl = document.querySelector('.flex.items-center.gap-1');
        if (statusEl) {
            statusEl.innerHTML = `
                <div id="live-dot" class="w-1.5 h-1.5 rounded-full ${hostCount > 0 ? 'bg-red-500 animate-pulse' : 'bg-gray-500'}"></div>
                <span id="live-text" class="text-[9px] font-mono ${hostCount > 0 ? 'text-red-500 font-bold' : 'text-gray-500'} uppercase">
                    ${hostCount > 0 ? 'LIVE' : 'OFFLINE'} â€¢ ${users.length} online
                </span>
            `;
        }
    });

    // âœ… Typing indicator
    socket.on('user-typing', (data) => {
        const typingIndicator = document.getElementById('typing-indicator');
        if (!typingIndicator) return;
        
        if (data.isTyping) {
            typingIndicator.innerHTML = `${data.user} is typing...`;
            typingIndicator.classList.remove('hidden');
        } else {
            typingIndicator.classList.add('hidden');
        }
    });

    // âœ… Gift receive
    socket.on('giftReceived', (data) => {
        addChatBubble("SYSTEM", `${data.user} sent ${data.gift}`, false, false, '#fbbf24');
        sendReaction(data.gift);
    });

    function sendMessage(e) {
        e.preventDefault();
        const inp = document.getElementById('msg-input');
        const txt = inp.value.trim();
        if(!txt) return;

        // show instantly
        addChatBubble(MY_NAME, txt, true, false, MY_COLOR);

        // send to global chat
        socket.emit('chatMessage', { 
            user: MY_NAME, 
            msg: txt,
            color: MY_COLOR
        });

        // Stop typing indicator
        socket.emit('typing', false);
        isTyping = false;
        
        inp.value = '';
    }

    // âœ… Typing detection
    function handleTyping() {
        const inp = document.getElementById('msg-input');
        if (!isTyping && inp.value.length > 0) {
            isTyping = true;
            socket.emit('typing', true);
        }
        
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            if (isTyping) {
                isTyping = false;
                socket.emit('typing', false);
            }
        }, 1000);
    }

    function addChatBubble(user, msg, isMe, isHost, color = '#3b82f6', isSystem = false) {
        const div = document.createElement('div');
        const align = isMe ? 'items-end' : 'items-start';

        let bg, nameColor;
        if (isSystem) {
            bg = 'bg-yellow-900/20 border border-yellow-500/20 text-yellow-200';
            nameColor = 'text-yellow-400';
        } else if (isMe) {
            bg = 'bg-indigo-600 text-white';
            nameColor = 'text-indigo-300';
        } else if (isHost) {
            bg = 'bg-red-900/30 border border-red-500/30 text-white';
            nameColor = 'text-red-300';
        } else {
            bg = 'bg-gray-800/50 border border-gray-700/50 text-gray-200';
            nameColor = 'text-gray-400';
        }

        div.className = `flex flex-col ${align} mb-3 animate-fadeIn`;
        div.innerHTML = `
            <div class="flex items-center gap-2 mb-0.5">
                <span class="text-[9px] ${nameColor} font-bold ml-1">${escapeHtml(user)}</span>
                ${isHost ? '<span class="text-[8px] bg-red-500 px-1 py-0.5 rounded uppercase">HOST</span>' : ''}
                ${isMe ? '<span class="text-[8px] bg-indigo-500 px-1 py-0.5 rounded uppercase">YOU</span>' : ''}
            </div>
            <div class="${bg} px-3 py-2 rounded-2xl text-xs max-w-[85%] shadow-sm break-words">${escapeHtml(msg)}</div>
            <span class="text-[8px] text-gray-500 mt-0.5 ml-1">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
        `;

        const box = document.getElementById('chat-box');
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function sendGift(icon) {
      socket.emit('sendGift', { 
          user: MY_NAME, 
          gift: icon,
          color: MY_COLOR
      });
      sendReaction(icon);
    }

    function sendReaction(emoji) {
        const el = document.createElement('div');
        el.innerText = emoji;
        el.className = 'float-emoji';
        el.style.left = Math.random() * 80 + 10 + '%';
        el.style.bottom = '150px';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 2000);
    }

    function playMessageSound() {
        try {
            const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
            audio.volume = 0.1;
            audio.play();
        } catch(e) {}
    }

    function initAudioContext() {
      if(audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      gainNode = audioCtx.createGain();
      gainNode.gain.value = 1.0;
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 128;
    }

    function toggleAudioBoost() {
      if(!gainNode) return;
      isBoosted = !isBoosted;
      gainNode.gain.value = isBoosted ? 3.0 : 1.0;
      showToast(isBoosted ? "ðŸš€ Audio Boost: ON" : "Audio Boost: OFF");
    }

    function reloadAudio() {
      audio.load();
      audio.play();
      showToast("Reloading Audio...");
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.innerText = msg;
      t.style.transform = "translate(-50%, 0)";
      setTimeout(() => t.style.transform = "translate(-50%, -100px)", 2000);
    }

    function shareStation() {
      navigator.clipboard.writeText(window.location.href);
      showToast("Link Copied!");
    }

    function toggleSleepTimer() {
      showToast("Sleep Timer: 30m set");
      setTimeout(() => { audio.pause(); showToast("Sleep Timer: End"); }, 30 * 60000);
    }

    function setupVisualizer(sourceNode) {
      sourceNode.connect(analyser);
      const canvas = document.getElementById('vis-canvas');
      const ctx = canvas.getContext('2d');
      const bufferLen = analyser.frequencyBinCount;
      const data = new Uint8Array(bufferLen);

      const resize = () => { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; };
      window.addEventListener('resize', resize);
      resize();

      function draw() {
        requestAnimationFrame(draw);
        if(visMode === 0) analyser.getByteFrequencyData(data);
        else analyser.getByteTimeDomainData(data);

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const barW = (canvas.width / bufferLen) * 2.5;
        let x = 0;

        for(let i=0; i<bufferLen; i++) {
          const v = data[i] / 128.0;
          const h = visMode === 0 ? (data[i]/255) * canvas.height * 0.8 : (v * canvas.height/4);
          const y = visMode === 0 ? (canvas.height - h)/2 : v * canvas.height/2;

          ctx.fillStyle = `rgba(99, 102, 241, ${visMode===0 ? data[i]/255 : 0.8})`;
          if(visMode === 0) {
            ctx.fillRect(x, y, barW - 2, h);
          } else {
            ctx.fillStyle = '#fff';
            ctx.fillRect(x, y, 2, 2);
          }
          x += barW;
        }
      }
      draw();
    }

    function toggleVisMode() {
      visMode = visMode === 0 ? 1 : 0;
      showToast(visMode === 0 ? "Visual: Spectrum" : "Visual: Waveform");
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[m]));
    }

    // Add typing indicator to chat box
    const chatBox = document.getElementById('chat-box');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.className = 'hidden text-[10px] text-gray-500 italic px-3 py-1';
    chatBox.appendChild(typingDiv);

    // Add username prompt if not set
    if (!localStorage.getItem('airvibe-username')) {
        setTimeout(() => {
            const name = prompt("Enter your display name for chat:", MY_NAME);
            if (name && name.trim()) {
                localStorage.setItem('airvibe-username', name.trim());
                location.reload();
            }
        }, 1000);
    }

    setInterval(() => { pingStart = Date.now(); socket.emit('ping'); }, 2000);
    
    // Add typing event listener
    document.getElementById('msg-input').addEventListener('input', handleTyping);
</script>
</body>
</html>
