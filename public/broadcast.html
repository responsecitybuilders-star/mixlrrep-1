<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Airvibe | Studio Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script> <style>
        /* === THEME: ONYX PRO === */
        :root {
            --bg: #09090b;
            --panel: #18181b;
            --border: #27272a;
            --primary: #6366f1;
            --accent: #a855f7;
            --danger: #ef4444;
            --success: #22c55e;
            --text: #e4e4e7;
            --font-ui: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        body { background: var(--bg); color: var(--text); font-family: var(--font-ui); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* LAYOUT */
        .grid-layout { display: grid; grid-template-columns: 320px 1fr 350px; height: 100%; border-top: 1px solid var(--border); }
        .panel { background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .scroll-y { overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
        
        /* COMPONENTS */
        .glass-header { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: rgba(9, 9, 11, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); }
        .btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: 0.2s; border: 1px solid var(--border); background: #27272a; color: white; display: flex; align-items: center; gap: 8px; justify-content: center; }
        .btn:hover { background: #3f3f46; }
        .btn-primary { background: var(--primary); border-color: var(--primary); }
        .btn-primary:hover { background: #4f46e5; }
        .btn-danger { background: rgba(239,68,68,0.1); color: var(--danger); border-color: rgba(239,68,68,0.2); }
        .btn-danger:hover { background: var(--danger); color: white; }

        .control-group { background: #000; padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px; }
        .label-sm { font-size: 0.7rem; color: #a1a1aa; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; margin-bottom: 8px; display: block; }
        
        /* SLIDERS */
        input[type=range] { width: 100%; height: 4px; background: #333; border-radius: 2px; accent-color: var(--primary); outline: none; -webkit-appearance: none; }
        
        /* VISUALIZER */
        .viz-container { flex: 1; position: relative; background: radial-gradient(circle at center, #1e1b4b 0%, #000 70%); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        canvas { width: 100%; height: 100%; position: absolute; inset: 0; }
        
        /* GO LIVE BUTTON */
        .big-btn { 
            width: 140px; height: 140px; border-radius: 50%; background: #111; border: 4px solid #333; 
            color: #555; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; transition: 0.3s; z-index: 10;
            box-shadow: 0 0 0 10px rgba(0,0,0,0.5);
        }
        .big-btn:hover { transform: scale(1.05); color: white; border-color: var(--primary); }
        .big-btn.live { background: #ef4444; color: white; border-color: #fca5a5; box-shadow: 0 0 50px rgba(239,68,68,0.4); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.7); } 70% { box-shadow: 0 0 0 20px rgba(239,68,68,0); } 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); } }

        /* CHAT */
        .chat-msg { padding: 8px 12px; font-size: 0.85rem; border-bottom: 1px solid #222; }
        .chat-msg b { color: var(--primary); font-family: var(--font-code); }
        .chat-msg.sys { border-left: 3px solid var(--warn); background: rgba(245,158,11,0.05); }
        .chat-msg.tip { border-left: 3px solid var(--success); background: rgba(34,197,94,0.05); }

        /* RESPONSIVE */
        @media(max-width: 1024px) { .grid-layout { grid-template-columns: 1fr; display: block; overflow-y: auto; } .panel { height: auto; min-height: 400px; border-bottom: 1px solid var(--border); } }
    </style>
</head>
<body id="app-body">

    <header class="glass-header">
        <div style="font-weight:900; font-size:1.2rem; display:flex; align-items:center; gap:10px;">
            <div style="width:12px; height:12px; background:var(--primary); transform:rotate(45deg);"></div>
            AIRVIBE <span class="bg-gray-800 text-xs px-2 py-1 rounded text-gray-400">STUDIO PRO</span>
        </div>
        
        <div class="hidden md:flex gap-6 font-mono text-xs text-gray-400">
            <span>CPU: <b class="text-white">12%</b></span>
            <span>NET: <b class="text-green-500">‚ñ†‚ñ†‚ñ†‚ñ†</b></span>
            <span class="flex items-center gap-2">üí∞ EARNED: <b class="text-yellow-400 text-sm" id="revenue-display">$0.00</b></span>
        </div>

        <div class="flex gap-3">
            <button class="btn" onclick="toggleCinemaMode()">üî¶ Lights</button>
            <div id="status-pill" class="px-3 py-1 bg-black border border-gray-800 rounded text-xs font-bold text-gray-500">‚óè OFFLINE</div>
        </div>
    </header>

    <div class="grid-layout">
        
        <div class="panel p-5 scroll-y">
            
            <div class="mb-5">
                <span class="label-sm">BROADCAST META</span>
                <input id="stream-title" class="w-full bg-black border border-gray-700 rounded p-2 text-sm text-white mb-2" placeholder="Stream Title" value="My Epic Live Session">
                <div class="flex gap-2">
                    <button class="btn flex-1" onclick="copyLink()">üîó Share</button>
                    <button class="btn btn-danger flex-1" onclick="location.reload()">‚ö† Reset</button>
                </div>
            </div>

            <div class="control-group">
                <div class="flex justify-between mb-2"><span class="label-sm">MICROPHONE</span> <span id="mic-val" class="text-xs text-blue-400">100%</span></div>
                <select id="audio-source" class="w-full bg-zinc-900 border border-zinc-700 rounded p-2 text-xs mb-4 text-white"></select>
                <input type="range" min="0" max="200" value="100" oninput="updateGain(this.value)">
                
                <div class="flex justify-between mt-4 mb-2"><span class="label-sm">NOISE GATE</span> <span class="text-xs text-gray-500">-50dB</span></div>
                <input type="range" min="-100" max="0" value="-50">
            </div>

            <div class="control-group">
                <span class="label-sm">VOICE FX RACK</span>
                <div class="grid grid-cols-2 gap-2">
                    <button class="btn bg-zinc-900" onclick="setFX('normal')">üéôÔ∏è Clean</button>
                    <button class="btn bg-zinc-900" onclick="setFX('radio')">üìª Radio</button>
                    <button class="btn bg-zinc-900" onclick="setFX('robot')">ü§ñ Robot</button>
                    <button class="btn bg-zinc-900" onclick="setFX('echo')">üì¢ Echo</button>
                </div>
            </div>

            <div class="control-group">
                <span class="label-sm">MUSIC BED</span>
                <div class="flex items-center gap-2 mb-2 p-2 bg-zinc-900 rounded cursor-pointer" onclick="document.getElementById('bgmFile').click()">
                    <span class="text-xl">üéµ</span>
                    <div class="overflow-hidden"><div class="text-xs font-bold truncate" id="bgm-name">Select Track...</div></div>
                </div>
                <input type="file" id="bgmFile" class="hidden" onchange="loadBGM(this)">
                
                <div class="flex gap-2 mb-2">
                    <button class="btn flex-1 text-xs" onclick="toggleBGM()">‚èØ Play/Pause</button>
                    <button class="btn flex-1 text-xs" onclick="toggleDuck()">ü¶Ü Ducking</button>
                </div>
                <input type="range" min="0" max="100" value="50" oninput="setBGMVol(this.value)">
            </div>

        </div>

        <div class="viz-container">
            <canvas id="visualizer"></canvas>
            
            <div class="absolute top-5 left-5 font-mono text-xs text-green-500 opacity-50">
                <div>AUD_CTX: ACTIVE</div>
                <div>RES: 1080p</div>
                <div>BITRATE: <span id="bitrate-disp">0</span> kbps</div>
            </div>

            <div class="absolute top-5 right-5 text-right">
                <div class="text-4xl font-black text-white tracking-tighter" id="session-timer">00:00:00</div>
                <div class="text-xs text-gray-500 font-mono tracking-widest">SESSION TIME</div>
            </div>

            <div class="z-10 flex flex-col items-center gap-6">
                <button id="go-live-btn" class="big-btn" onclick="startBroadcast()">
                    <div class="text-2xl font-black">GO</div>
                    <div class="text-xs font-bold tracking-widest">LIVE</div>
                </button>

                <div class="flex gap-4">
                    <button class="w-12 h-12 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center hover:bg-white hover:text-black transition" onclick="toggleMute()" title="Mute Mic">üîá</button>
                    <button class="w-12 h-12 rounded-full bg-zinc-900 border border-zinc-700 flex items-center justify-center hover:bg-red-500 hover:text-white transition" onclick="toggleRecording()" title="Record">üî¥</button>
                </div>
            </div>

            <div class="absolute bottom-10 font-mono text-xs text-gray-600">
                <span id="rec-status" class="hidden text-red-500 mr-4">‚óè RECORDING (24MB)</span>
                <span>listeners: <b class="text-white" id="listener-count">0</b></span>
            </div>
        </div>

        <div class="panel bg-black border-l border-zinc-800 flex flex-col">
            
            <div class="p-4 border-b border-zinc-800 bg-zinc-900/50">
                <span class="label-sm">üèÜ TOP SUPPORTER</span>
                <div class="flex items-center gap-3 mt-2">
                    <div class="w-8 h-8 rounded-full bg-yellow-500 flex items-center justify-center text-black font-bold">1</div>
                    <div>
                        <div class="text-sm font-bold text-white">Guest-9281</div>
                        <div class="text-xs text-yellow-500">500 Coins</div>
                    </div>
                </div>
            </div>

            <div class="p-3 border-b border-zinc-800 flex justify-between items-center">
                <span class="label-sm">LIVE CHAT</span>
                <button class="text-xs text-gray-500 hover:text-white" onclick="clearChat()">Clear</button>
            </div>

            <div class="flex-1 scroll-y p-0" id="chat-feed">
                <div class="p-4 text-center text-xs text-gray-600 mt-10">
                    System initialized.<br>Waiting for connection...
                </div>
            </div>

            <div class="p-3 border-t border-zinc-800 bg-zinc-900">
                <div class="flex gap-2">
                    <input id="chat-input" class="flex-1 bg-black border border-zinc-700 rounded p-2 text-sm text-white focus:border-blue-500" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendHostMessage()">
                    <button class="btn btn-primary" onclick="sendHostMessage()">Send</button>
                </div>
                <div class="flex gap-2 mt-2">
                    <button class="btn flex-1 text-xs py-1" onclick="runPoll()">üìä Poll</button>
                    <button class="btn flex-1 text-xs py-1" onclick="toggleSlowMode()">üê¢ Slow</button>
                </div>
            </div>
        </div>

    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let isLive = false;
        let audioCtx, micSource, micGain, bgmSource, bgmGain;
        let bgmAudio = new Audio(); bgmAudio.loop = true;
        let revenue = 0;
        let timerInterval, seconds = 0;

        // --- 1. CORE BROADCAST ENGINE ---
        async function startBroadcast() {
            if (isLive) return stopBroadcast(); // Toggle logic

            try {
                // Audio Context Init
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                // Get Mic
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Audio Graph: Mic -> Gain -> Destination
                micSource = audioCtx.createMediaStreamSource(stream);
                micGain = audioCtx.createGain();
                micSource.connect(micGain);
                // Note: In real WebRTC, we connect this destination to the PeerConnection
                
                // Visualizer
                setupVisualizer(micGain);

                // Server Signal
                const title = document.getElementById('stream-title').value;
                socket.emit('broadcaster', { title: title, host: 'Host' });

                // UI Updates
                isLive = true;
                const btn = document.getElementById('go-live-btn');
                btn.classList.add('live');
                btn.innerHTML = '<div class="text-2xl font-black">END</div><div class="text-xs font-bold tracking-widest">STREAM</div>';
                document.getElementById('status-pill').className = "px-3 py-1 bg-red-500/20 border border-red-500/50 rounded text-xs font-bold text-red-500 animate-pulse";
                document.getElementById('status-pill').innerText = "‚óè ON AIR";
                
                // Timer
                seconds = 0;
                timerInterval = setInterval(() => {
                    seconds++;
                    document.getElementById('session-timer').innerText = new Date(seconds * 1000).toISOString().substr(11, 8);
                    // Fake Bitrate fluctuation
                    document.getElementById('bitrate-disp').innerText = Math.floor(Math.random() * (320 - 280) + 280);
                }, 1000);

                addLog("System", "Broadcast started successfully.", "sys");

            } catch (err) {
                alert("Microphone Access Denied! Please allow microphone permissions.");
                console.error(err);
            }
        }

        function stopBroadcast() {
            isLive = false;
            socket.emit('disconnect'); // Or custom stop event
            location.reload(); // Simple reset
        }

        // --- 2. AUDIO TOOLS ---
        function updateGain(val) {
            if(micGain) micGain.gain.value = val / 100;
            document.getElementById('mic-val').innerText = val + '%';
        }

        function loadBGM(input) {
            if(input.files[0]) {
                const file = input.files[0];
                document.getElementById('bgm-name').innerText = file.name;
                bgmAudio.src = URL.createObjectURL(file);
                addLog("System", `Loaded track: ${file.name}`, "sys");
            }
        }

        function toggleBGM() {
            if(bgmAudio.paused) bgmAudio.play(); else bgmAudio.pause();
        }

        function setBGMVol(val) { bgmAudio.volume = val / 100; }

        // --- 3. VISUALIZER ---
        function setupVisualizer(sourceNode) {
            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = canvas.parentElement.offsetHeight;

            const analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256;
            sourceNode.connect(analyser);

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function draw() {
                if(!isLive) return;
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const barWidth = (canvas.width / bufferLength) * 2.5;
                let barHeight;
                let x = 0;

                for(let i = 0; i < bufferLength; i++) {
                    barHeight = dataArray[i] / 1.5; // Scale height
                    
                    // Gradient color
                    const gradient = ctx.createLinearGradient(0, canvas.height, 0, canvas.height - barHeight);
                    gradient.addColorStop(0, '#6366f1');
                    gradient.addColorStop(1, '#a855f7');
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            }
            draw();
        }

        // --- 4. SOCIAL & CHAT ---
        function sendHostMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value;
            if(!text) return;
            
            // Local add
            addLog("HOST", text);
            // Emit
            socket.emit('chatMessage', { room: socket.id, user: 'HOST', msg: text });
            input.value = '';
        }

        function addLog(user, text, type='') {
            const feed = document.getElementById('chat-feed');
            const div = document.createElement('div');
            div.className = `chat-msg ${type}`;
            div.innerHTML = `<b>${user}:</b> ${text}`;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        // Socket Listeners for Interaction
        socket.on('chatMessage', data => addLog(data.user || 'Guest', data.msg));
        socket.on('giftReceived', data => {
            const val = data.gift === 'üöÄ' ? 5 : 1;
            revenue += val;
            document.getElementById('revenue-display').innerText = `$${revenue.toFixed(2)}`;
            addLog("SYSTEM", `${data.user} sent ${data.gift} (+$${val})`, "tip");
        });
        socket.on('roomLog', data => {
            if(data.type === 'join') document.getElementById('listener-count').innerText = data.count;
        });

        // --- 5. UTILS ---
        function toggleCinemaMode() {
            document.getElementById('app-body').classList.toggle('brightness-50');
        }
        function copyLink() {
            navigator.clipboard.writeText(window.location.origin);
            alert("Studio Link Copied!");
        }
        function clearChat() {
            document.getElementById('chat-feed').innerHTML = '<div class="p-4 text-center text-xs text-gray-600 mt-10">Chat cleared by Host.</div>';
        }

        // Populate Audio Inputs
        navigator.mediaDevices.enumerateDevices().then(devices => {
            const select = document.getElementById('audio-source');
            devices.filter(d => d.kind === 'audioinput').forEach(d => {
                const opt = document.createElement('option');
                opt.text = d.label || `Microphone ${select.length + 1}`;
                select.add(opt);
            });
        });
    </script>
</body>
</html>