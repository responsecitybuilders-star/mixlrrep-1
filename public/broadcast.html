<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airvibe Studio | Diagnostic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #debug-console { position: fixed; bottom: 0; left: 0; width: 100%; height: 150px; background: rgba(0,0,0,0.9); color: #0f0; font-family: monospace; font-size: 10px; overflow-y: scroll; z-index: 9999; padding: 10px; border-top: 1px solid #0f0; }
        .log-line { margin-bottom: 2px; border-bottom: 1px solid #333; }
        .pulse-live { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="bg-black text-white h-screen flex flex-col">

    <div class="p-4 border-b border-gray-800 flex justify-between items-center">
        <h1 class="font-bold text-indigo-500">STUDIO DIAGNOSTIC</h1>
        <div id="live-dot" class="w-3 h-3 rounded-full bg-gray-500"></div>
    </div>

    <div class="flex-1 flex flex-col items-center justify-center gap-6">
        <div class="text-center">
            <div class="text-xs text-gray-500 mb-2">MIC STATUS</div>
            <div id="mic-status" class="text-xl font-bold text-red-500">OFF</div>
        </div>

        <button id="main-btn" onclick="startBroadcast()" class="w-40 h-40 rounded-full bg-white text-black font-black text-xl shadow-lg shadow-indigo-500/50 hover:scale-105 transition">
            GO LIVE
        </button>

        <div class="text-xs text-gray-500 mt-4 text-center">
            Chunk Size: <span id="chunk-size">0</span> bytes<br>
            Packets Sent: <span id="packet-count">0</span>
        </div>
        
        <button onclick="document.getElementById('bgm-file').click()" class="text-xs border border-white/20 p-2 rounded">üéµ Load Music</button>
        <input type="file" id="bgm-file" hidden onchange="loadMusic(this)">
    </div>

    <div id="debug-console">Waiting for user...</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let mediaRecorder;
        let audioCtx;
        let packets = 0;
        let bgmAudio = new Audio();
        let bgmSource, bgmGain, micGain, masterDest;

        function log(msg) {
            const box = document.getElementById('debug-console');
            box.innerHTML = `<div class="log-line">[${new Date().toLocaleTimeString()}] ${msg}</div>` + box.innerHTML;
        }

        async function startBroadcast() {
            try {
                log("üöÄ Initializing Audio Engine...");
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                masterDest = audioCtx.createMediaStreamDestination();
                micGain = audioCtx.createGain();
                bgmGain = audioCtx.createGain();
                
                micGain.connect(masterDest);
                bgmGain.connect(masterDest);

                // 1. GET MIC (No Echo Cancellation for Raw Power)
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        echoCancellation: false, 
                        noiseSuppression: false, 
                        autoGainControl: false 
                    } 
                });
                
                const micSource = audioCtx.createMediaStreamSource(stream);
                micSource.connect(micGain);

                log("‚úÖ Microphone Access Granted");
                document.getElementById('mic-status').innerText = "ACTIVE";
                document.getElementById('mic-status').className = "text-xl font-bold text-green-500";

                // 2. SETUP RECORDER
                // Prefer 'audio/webm' for reliability on Android Chrome
                let mimeType = 'audio/webm;codecs=opus';
                if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = 'audio/mp4';
                
                log(`‚ÑπÔ∏è Using Codec: ${mimeType}`);

                // Connect to Socket
                socket.emit('broadcaster', { title: "Diagnostic Stream", host: "DebugUser", mimeType: mimeType });
                
                mediaRecorder = new MediaRecorder(masterDest.stream, { mimeType: mimeType, audioBitsPerSecond: 128000 });

                mediaRecorder.ondataavailable = async (e) => {
                    if (e.data.size > 0) {
                        const buffer = await e.data.arrayBuffer();
                        socket.emit('audioStream', { room: socket.id, chunk: buffer });
                        
                        // UPDATE UI
                        packets++;
                        document.getElementById('chunk-size').innerText = e.data.size;
                        document.getElementById('packet-count').innerText = packets;
                        
                        // Log first 5 packets to verify start
                        if (packets < 5 || packets % 10 === 0) log(`üì§ Sent Packet #${packets}: ${e.data.size} bytes`);
                        
                        // Visual Dot Flash
                        const dot = document.getElementById('live-dot');
                        dot.style.backgroundColor = '#22c55e'; // Green
                        setTimeout(() => dot.style.backgroundColor = '#ef4444', 500); // Red
                    } else {
                        log("‚ö†Ô∏è Empty Chunk Detected!");
                    }
                };

                // 3. START (1 Second Chunks)
                mediaRecorder.start(1000); 
                log("üî¥ RECORDER STARTED (1000ms chunks)");
                
                document.getElementById('main-btn').innerText = "STOP";
                document.getElementById('main-btn').className = "w-40 h-40 rounded-full bg-red-600 text-white font-black text-xl pulse-live";
                document.getElementById('main-btn').onclick = () => location.reload(); // Hard reset to stop

            } catch (err) {
                log("‚ùå CRITICAL ERROR: " + err.message);
                alert("Error: " + err.message);
            }
        }

        function loadMusic(input) {
            if (input.files[0]) {
                bgmAudio.src = URL.createObjectURL(input.files[0]);
                bgmSource = audioCtx.createMediaElementSource(bgmAudio);
                bgmSource.connect(bgmGain);
                bgmAudio.play();
                log("üéµ Music Loaded & Playing");
            }
        }
    </script>
</body>
</html>